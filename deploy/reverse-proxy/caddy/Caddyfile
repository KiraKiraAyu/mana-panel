{
	admin off
	auto_https off

	servers {
		protocols h1 h2 h3
		max_header_size 32KB

		timeouts {
			read_header 10s
			read_body 30s
			write 0
			idle 120s
		}
	}
}

{$SITE_ADDRESS:0.0.0.0:80} {
	encode zstd gzip

	# Security and proxy-aware headers
	header {
		-Server
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		Referrer-Policy "strict-origin-when-cross-origin"
	}

	# Cache immutable frontend static assets aggressively
	header /assets/* Cache-Control "public, max-age=31536000, immutable"
	header /favicon.ico Cache-Control "public, max-age=86400"
	header /manifest.webmanifest Cache-Control "public, max-age=3600"

	# API stream endpoint (SSE): disable buffering for low latency
	@api_sse path /api/system/stats/stream
	handle @api_sse {
		reverse_proxy {$BACKEND_UPSTREAM:mana-panel-backend:3000} {
			lb_policy least_conn
			health_uri /api/system/info
			health_interval 30s
			health_timeout 3s

			flush_interval -1

			header_up X-Forwarded-Proto {scheme}
			header_up X-Forwarded-Host {host}
			header_up X-Forwarded-For {remote_host}

			transport http {
				dial_timeout 3s
				response_header_timeout 30s
				keepalive 30s
				keepalive_idle_conns 64
				read_timeout 0
				write_timeout 0
			}
		}
	}

	# API routes (includes websocket-capable endpoints)
	@api path /api/*
	handle @api {
		reverse_proxy {$BACKEND_UPSTREAM:mana-panel-backend:3000} {
			lb_policy least_conn
			health_uri /api/system/info
			health_interval 30s
			health_timeout 3s

			header_up X-Forwarded-Proto {scheme}
			header_up X-Forwarded-Host {host}
			header_up X-Forwarded-For {remote_host}

			transport http {
				dial_timeout 3s
				response_header_timeout 30s
				keepalive 30s
				keepalive_idle_conns 64
			}
		}
	}

	# Frontend SPA (served by frontend container, e.g. nginx)
	handle {
		reverse_proxy {$FRONTEND_UPSTREAM:mana-panel-frontend:80} {
			lb_policy random_choose 2
			health_uri /
			health_interval 30s
			health_timeout 3s

			transport http {
				dial_timeout 3s
				response_header_timeout 15s
				keepalive 30s
				keepalive_idle_conns 64
			}
		}
	}

	log {
		level INFO
		output stdout
		format json
	}
}
